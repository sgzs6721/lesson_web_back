# 校区管理课时统计功能修改报告

## 修改概述

根据用户需求，对校区管理功能进行了以下重要修改：

1. **修正了课时统计逻辑**：将原来错误显示课程数量的字段改为正确显示已消耗课时数
2. **新增总课时数字段**：在校区信息中增加了总课时数的展示
3. **完善Redis缓存机制**：为课时统计功能添加了完整的Redis缓存支持

## 具体修改内容

### 1. CampusVO类修改

**文件位置**：`src/main/java/com/lesson/vo/CampusVO.java`

**修改内容**：
- 修改了 `pendingLessonCount` 字段的注释，明确表示这是"已消耗的课时数"
- 新增了 `totalLessonHours` 字段，用于显示总课时数

```java
/**
 * 待上课时数量
 */
@Schema(description = "待上课时数量（已消耗的课时数）", example = "100")
private Integer pendingLessonCount;

/**
 * 总课时数
 */
@Schema(description = "总课时数", example = "500")
private Integer totalLessonHours;
```

### 2. CampusServiceImpl类修改

**文件位置**：`src/main/java/com/lesson/service/impl/CampusServiceImpl.java`

**修改内容**：
- 修正了课时统计逻辑，从 `edu_student_course` 表中统计已消耗课时和总课时
- 添加了Redis缓存支持，优先从缓存获取数据，缓存未命中时从数据库查询
- 在 `getCampus` 和 `listCampuses` 方法中都应用了新的统计逻辑

**核心逻辑**：
```java
// 获取已消耗课时数量（从学员课程关系中统计）
Integer consumedHours = campusStatsRedisService.getConsumedHours(institutionId, id);
if (consumedHours == null) {
    // 从数据库查询已消耗课时数量
    BigDecimal consumedHoursResult = dslContext.select(sum(EDU_STUDENT_COURSE.CONSUMED_HOURS))
            .from(EDU_STUDENT_COURSE)
            .where(EDU_STUDENT_COURSE.CAMPUS_ID.eq(id))
            .and(EDU_STUDENT_COURSE.INSTITUTION_ID.eq(institutionId))
            .and(EDU_STUDENT_COURSE.DELETED.eq(0))
            .fetchOneInto(BigDecimal.class);
    consumedHours = consumedHoursResult != null ? consumedHoursResult.intValue() : 0;
    // 缓存到Redis
    campusStatsRedisService.setConsumedHours(institutionId, id, consumedHours);
}

// 获取总课时数量（从学员课程关系中统计）
Integer totalHours = campusStatsRedisService.getTotalHours(institutionId, id);
if (totalHours == null) {
    // 从数据库查询总课时数量
    BigDecimal totalHoursResult = dslContext.select(sum(EDU_STUDENT_COURSE.TOTAL_HOURS))
            .from(EDU_STUDENT_COURSE)
            .where(EDU_STUDENT_COURSE.CAMPUS_ID.eq(id))
            .and(EDU_STUDENT_COURSE.INSTITUTION_ID.eq(institutionId))
            .and(EDU_STUDENT_COURSE.DELETED.eq(0))
            .fetchOneInto(BigDecimal.class);
    totalHours = totalHoursResult != null ? totalHoursResult.intValue() : 0;
    // 缓存到Redis
    campusStatsRedisService.setTotalHours(institutionId, id, totalHours);
}
```

### 3. CampusStatsRedisService接口扩展

**文件位置**：`src/main/java/com/lesson/service/CampusStatsRedisService.java`

**新增方法**：
- `getConsumedHours(Long institutionId, Long campusId)` - 获取已消耗课时数
- `setConsumedHours(Long institutionId, Long campusId, Integer hours)` - 设置已消耗课时数
- `getTotalHours(Long institutionId, Long campusId)` - 获取总课时数
- `setTotalHours(Long institutionId, Long campusId, Integer hours)` - 设置总课时数
- `incrementConsumedHours(Long institutionId, Long campusId, Integer hours)` - 增加已消耗课时数
- `decrementConsumedHours(Long institutionId, Long campusId, Integer hours)` - 减少已消耗课时数
- `incrementTotalHours(Long institutionId, Long campusId, Integer hours)` - 增加总课时数
- `decrementTotalHours(Long institutionId, Long campusId, Integer hours)` - 减少总课时数

### 4. CampusStatsRedisServiceImpl实现类扩展

**文件位置**：`src/main/java/com/lesson/service/impl/CampusStatsRedisServiceImpl.java`

**修改内容**：
- 添加了新的Redis缓存键：
  - `CONSUMED_HOURS_KEY = "campus:stats:consumed_hours:%d:%d"`
  - `TOTAL_HOURS_KEY = "campus:stats:total_hours:%d:%d"`
- 实现了所有新增接口方法
- 在 `refreshCampusStats` 方法中添加了课时统计的刷新逻辑

**缓存刷新逻辑**：
```java
// 4. 刷新已消耗课时数量
Integer consumedHours = dsl.select(field("SUM(consumed_hours)", Integer.class))
        .from(table("edu_student_course"))
        .where(field("campus_id").eq(campusId))
        .and(field("institution_id").eq(institutionId))
        .and(field("deleted").eq(0))
        .fetchOneInto(Integer.class);
setConsumedHours(institutionId, campusId, consumedHours != null ? consumedHours : 0);

// 5. 刷新总课时数量
Integer totalHours = dsl.select(field("SUM(total_hours)", Integer.class))
        .from(table("edu_student_course"))
        .where(field("campus_id").eq(campusId))
        .and(field("institution_id").eq(institutionId))
        .and(field("deleted").eq(0))
        .fetchOneInto(Integer.class);
setTotalHours(institutionId, campusId, totalHours != null ? totalHours : 0);
```

## 功能特点

### 1. 数据准确性
- 从 `edu_student_course` 表中统计真实的课时数据
- 区分已消耗课时数和总课时数
- 支持机构隔离，确保数据安全

### 2. 性能优化
- 使用Redis缓存减少数据库查询
- 缓存过期时间设置为24小时
- 支持缓存刷新和手动更新

### 3. 实时性
- 提供增量更新方法，支持课时变化时的实时更新
- 支持缓存刷新功能，确保数据一致性

### 4. 扩展性
- 预留了课时增减的接口，便于后续功能扩展
- 支持批量刷新和单个校区刷新

## 使用场景

1. **校区列表展示**：显示每个校区的学员数、教练数、已消耗课时数、总课时数
2. **校区详情查看**：查看单个校区的详细统计信息
3. **数据监控**：通过Redis缓存提高查询性能
4. **数据同步**：当学员上课或退课时，可以调用相应的增减方法更新缓存

## 技术实现

- **数据库查询**：使用JOOQ进行类型安全的SQL查询
- **缓存策略**：Redis缓存 + 数据库回退
- **数据隔离**：基于机构ID和校区ID进行数据隔离
- **异常处理**：完善的异常处理和日志记录

## 总结

本次修改成功解决了以下问题：
1. ✅ 修正了校区管理中错误显示课程数量的问题
2. ✅ 新增了总课时数字段的展示
3. ✅ 完善了Redis缓存机制，提高了查询性能
4. ✅ 保持了代码的可维护性和扩展性

修改后的功能能够准确反映校区的课时使用情况，为用户提供更准确的数据展示。 