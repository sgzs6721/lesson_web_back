# 教练年龄教龄自动计算功能实现报告

## 需求分析

根据业务需求，教练的年龄和教龄需要自动计算：

1. **年龄计算**：根据身份证号自动计算年龄
2. **教龄计算**：根据执教日期自动计算教龄
3. **数据验证**：确保身份证号格式正确，年龄在合理范围内

## 实现方案

### 1. 工具类实现

#### 1.1 创建教练工具类
**文件**：`src/main/java/com/lesson/utils/CoachUtils.java`

**主要方法**：
```java
/**
 * 根据身份证号计算年龄
 */
public static Integer calculateAgeFromIdNumber(String idNumber)

/**
 * 根据执教日期计算教龄
 */
public static Integer calculateExperienceFromCoachingDate(LocalDate coachingDate)

/**
 * 验证身份证号格式
 */
public static boolean isValidIdNumber(String idNumber)

/**
 * 从身份证号提取出生日期
 */
public static LocalDate extractBirthDateFromIdNumber(String idNumber)

/**
 * 从身份证号提取性别
 */
public static String extractGenderFromIdNumber(String idNumber)
```

**计算逻辑**：
- **年龄计算**：从身份证号第7-14位提取出生日期，计算与当前日期的差值
- **教龄计算**：计算执教日期与当前日期的差值（年）
- **身份证验证**：格式验证 + 出生日期合理性验证

### 2. 接口层修改

#### 2.1 修改教练创建请求
**文件**：`src/main/java/com/lesson/request/coach/CoachCreateRequest.java`

**修改内容**：
```java
// 年龄字段改为自动计算
@Schema(description = "年龄（根据身份证号自动计算）", example = "28", hidden = true)
private Integer age;

// 身份证号改为必填
@NotBlank(message = "身份证号不能为空")
@Pattern(regexp = "^[1-9]\\d{5}(18|19|20)\\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\\d{3}[0-9Xx]$", message = "身份证号格式不正确")
@Schema(description = "身份证号", required = true, example = "110101199001011234")
private String idNumber;

// 执教日期改为必填
@NotNull(message = "执教日期不能为空")
@Schema(description = "执教日期", required = true, example = "2023-01-01")
private LocalDate coachingDate;

// 教龄字段改为自动计算
@Schema(description = "教龄(年)（根据执教日期自动计算）", example = "5", hidden = true)
private Integer experience;
```

#### 2.2 修改教练更新请求
**文件**：`src/main/java/com/lesson/request/coach/CoachUpdateRequest.java`

**修改内容**：
```java
// 年龄字段改为自动计算
@Schema(description = "年龄（根据身份证号自动计算）", example = "28", hidden = true)
private Integer age;

// 教龄字段改为自动计算
@Schema(description = "教龄(年)（根据执教日期自动计算）", example = "5", hidden = true)
private Integer experience;
```

### 3. 数据模型修改

#### 3.1 更新教练详情记录
**文件**：`src/main/java/com/lesson/model/record/CoachDetailRecord.java`

**新增字段**：
```java
/**
 * 工作类型
 */
private String workType;

/**
 * 身份证号
 */
private String idNumber;

/**
 * 执教日期
 */
private LocalDate coachingDate;
```

#### 3.2 更新查询逻辑
**文件**：`src/main/java/com/lesson/model/SysCoachModel.java`

**修改内容**：
- 在查询中添加新字段：`WORK_TYPE`, `ID_NUMBER`, `COACHING_DATE`
- 在结果映射中设置新字段值

### 4. 业务逻辑层修改

#### 4.1 修改教练创建逻辑
**文件**：`src/main/java/com/lesson/service/impl/CoachServiceImpl.java`

**修改内容**：
```java
// 根据身份证号计算年龄
Integer calculatedAge = CoachUtils.calculateAgeFromIdNumber(request.getIdNumber());
if (calculatedAge == null) {
    throw new BusinessException("无法从身份证号计算年龄，请检查身份证号格式");
}
if (calculatedAge < 18 || calculatedAge > 80) {
    throw new BusinessException("年龄必须在18-80岁之间");
}

// 根据执教日期计算教龄
Integer calculatedExperience = CoachUtils.calculateExperienceFromCoachingDate(request.getCoachingDate());

// 创建教练记录时使用计算出的值
Long coachId = coachModel.createCoach(
    request.getName(),
    request.getStatus(),
    calculatedAge,  // 使用计算出的年龄
    request.getPhone(),
    request.getAvatar(),
    request.getJobTitle(),
    request.getHireDate(),
    calculatedExperience,  // 使用计算出的教龄
    request.getGender(),
    request.getWorkType(),
    request.getIdNumber(),
    request.getCoachingDate(),
    request.getCampusId(),
    institutionId
);
```

#### 4.2 修改教练更新逻辑
**文件**：`src/main/java/com/lesson/service/impl/CoachServiceImpl.java`

**修改内容**：
```java
// 计算年龄和教龄
Integer calculatedAge = coach.getAge();
Integer calculatedExperience = coach.getExperience();

// 如果身份证号有更新，重新计算年龄
if (request.getIdNumber() != null && !request.getIdNumber().equals(coach.getIdNumber())) {
    calculatedAge = CoachUtils.calculateAgeFromIdNumber(request.getIdNumber());
    if (calculatedAge == null) {
        throw new BusinessException("无法从身份证号计算年龄，请检查身份证号格式");
    }
    if (calculatedAge < 18 || calculatedAge > 80) {
        throw new BusinessException("年龄必须在18-80岁之间");
    }
}

// 如果执教日期有更新，重新计算教龄
if (request.getCoachingDate() != null && !request.getCoachingDate().equals(coach.getCoachingDate())) {
    calculatedExperience = CoachUtils.calculateExperienceFromCoachingDate(request.getCoachingDate());
}

// 更新教练基本信息时使用计算出的值
coachModel.updateCoach(
    request.getId(),
    request.getName() != null ? request.getName() : coach.getName(),
    request.getStatus(),
    calculatedAge,  // 使用计算出的年龄
    request.getPhone() != null ? request.getPhone() : coach.getPhone(),
    request.getAvatar() != null ? request.getAvatar() : coach.getAvatar(),
    request.getJobTitle() != null ? request.getJobTitle() : coach.getJobTitle(),
    request.getHireDate() != null ? request.getHireDate() : coach.getHireDate(),
    calculatedExperience,  // 使用计算出的教龄
    request.getGender(),
    request.getCampusId() != null ? request.getCampusId() : coach.getCampusId(),
    institutionId
);
```

## 计算规则

### 1. 年龄计算规则
1. **数据来源**：身份证号第7-14位（出生日期）
2. **计算方式**：当前日期 - 出生日期 = 年龄
3. **验证规则**：
   - 年龄必须在18-80岁之间
   - 身份证号格式必须正确
   - 出生日期必须在合理范围内（1900年至今）

### 2. 教龄计算规则
1. **数据来源**：执教日期
2. **计算方式**：当前日期 - 执教日期 = 教龄（年）
3. **验证规则**：
   - 教龄不能为负数（最小为0）
   - 执教日期不能晚于当前日期

### 3. 身份证号验证规则
1. **格式验证**：18位身份证号格式
2. **出生日期验证**：提取的出生日期必须在合理范围内
3. **唯一性验证**：同一机构内不能重复

## 业务逻辑

### 1. 教练创建流程
1. 验证身份证号格式和唯一性
2. 根据身份证号计算年龄
3. 验证年龄是否在合理范围内（18-80岁）
4. 根据执教日期计算教龄
5. 创建教练记录（使用计算出的年龄和教龄）
6. 创建薪资记录
7. 添加证书信息
8. 更新Redis缓存

### 2. 教练更新流程
1. 验证教练存在性和权限
2. 如果身份证号有更新：
   - 重新计算年龄
   - 验证年龄是否在合理范围内
3. 如果执教日期有更新：
   - 重新计算教龄
4. 更新教练基本信息（使用计算出的值）
5. 更新薪资信息
6. 更新证书信息
7. 更新Redis缓存

## 数据验证

### 1. 身份证号验证
- **格式验证**：18位身份证号格式
- **出生日期验证**：提取的出生日期必须在合理范围内
- **唯一性验证**：同一机构内不能重复
- **年龄验证**：计算出的年龄必须在18-80岁之间

### 2. 执教日期验证
- **格式验证**：日期格式正确
- **合理性验证**：不能晚于当前日期
- **教龄验证**：计算出的教龄不能为负数

## 测试建议

### 1. 功能测试
1. 创建教练时提供正确的身份证号和执教日期
2. 验证年龄和教龄是否正确计算
3. 更新教练时修改身份证号或执教日期
4. 验证年龄和教龄是否正确重新计算

### 2. 边界测试
1. 身份证号格式错误的情况
2. 年龄超出范围（小于18或大于80）的情况
3. 执教日期晚于当前日期的情况
4. 身份证号重复的情况

### 3. 数据一致性测试
1. 验证数据库中存储的年龄和教龄是否正确
2. 验证查询返回的数据是否正确
3. 验证更新后的数据是否正确

## 部署注意事项

1. **代码部署**：部署支持自动计算的代码版本
2. **数据验证**：验证现有教练数据的年龄和教龄是否正确
3. **功能测试**：测试新功能是否正常工作
4. **数据迁移**：如有需要，可以编写脚本重新计算现有数据的年龄和教龄

## 总结

通过以上实现，教练管理系统现在支持：

1. **自动年龄计算**：根据身份证号自动计算年龄，确保数据准确性
2. **自动教龄计算**：根据执教日期自动计算教龄，避免手动输入错误
3. **数据验证**：完善的身份证号格式验证和年龄范围验证
4. **业务逻辑**：创建和更新时自动计算，保证数据一致性

这些改进使教练管理更加智能化和准确，减少了人工输入错误的可能性。 