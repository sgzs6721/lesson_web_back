# 课程多教师课时费功能实现报告

## 功能概述
为课程管理添加多教师课时费支持，允许在创建和更新课程时为每个教练设置不同的课时费，满足多教师教学场景下的个性化课时费需求。

## 需求分析
根据UI界面显示，当前系统支持多教师教学，但每个教练的课时费不同：
- 武文册：¥95
- 苗寒青：¥95  
- 张鲁风：¥90
- 平均课时费：¥92.5

需要修改系统架构来支持每个教练在特定课程中有独立的课时费设置。

## 实现方案

### 1. 数据库变更

#### 新增数据库迁移脚本
**文件**: `src/main/resources/db/migration/V29__add_coach_fee_to_coach_course.sql`

```sql
-- 为教练课程关联表添加课时费字段
ALTER TABLE `sys_coach_course`
ADD COLUMN `coach_fee` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '该教练在此课程中的课时费(元)' AFTER `course_id`;

-- 添加索引
ALTER TABLE `sys_coach_course`
ADD KEY `idx_coach_fee` (`coach_fee`);
```

### 2. JOOQ模型更新

#### 更新SysCoachCourse表类
**文件**: `src/main/java/com/lesson/repository/tables/SysCoachCourse.java`
- 添加`COACH_FEE`字段（BigDecimal类型）
- 更新`fieldsRow()`方法签名从`Row6`到`Row7`
- 添加`BigDecimal`和`Row7`导入

#### 更新SysCoachCourseRecord类
**文件**: `src/main/java/com/lesson/repository/tables/records/SysCoachCourseRecord.java`
- 添加`coachFee`字段的getter和setter方法
- 更新Record接口实现从`Record6`到`Record7`
- 更新所有相关方法签名

### 3. 请求类更新

#### 新增CoachFeeRequest类
**文件**: `src/main/java/com/lesson/vo/request/CoachFeeRequest.java`

```java
@Data
@Schema(description = "教练课时费请求")
public class CoachFeeRequest {
    @NotNull(message = "教练ID不能为空")
    @Schema(description = "教练ID", required = true, example = "1")
    private Long coachId;
    
    @NotNull(message = "课时费不能为空")
    @PositiveOrZero(message = "课时费必须大于等于0")
    @Schema(description = "课时费", required = true, example = "100.00")
    private BigDecimal coachFee;
}
```

#### 更新CourseCreateRequest类
**文件**: `src/main/java/com/lesson/vo/request/CourseCreateRequest.java`
- 移除冗余的`coachIds`字段
- 添加`coachFees`字段（List<CoachFeeRequest>类型）
- 添加Swagger注解说明

#### 更新CourseUpdateRequest类
**文件**: `src/main/java/com/lesson/vo/request/CourseUpdateRequest.java`
- 移除冗余的`coachIds`字段
- 添加`coachFees`字段（List<CoachFeeRequest>类型）
- 添加Swagger注解说明

### 4. 返回类更新

#### 更新CourseVO.CoachInfo类
**文件**: `src/main/java/com/lesson/vo/CourseVO.java`
- 在`CoachInfo`内部类中添加`coachFee`字段
- 添加Swagger注解说明

#### 更新CoachDetailRecord类
**文件**: `src/main/java/com/lesson/model/record/CoachDetailRecord.java`
- 添加`coachFee`字段（BigDecimal类型）

### 5. 模型层更新

#### 更新EduCourseModel类
**文件**: `src/main/java/com/lesson/model/EduCourseModel.java`
- 修改`createCourseCoachRelation`方法签名，添加`BigDecimal coachFee`参数
- 在创建、更新和恢复关联时都设置课时费

#### 更新SysCoachModel类
**文件**: `src/main/java/com/lesson/model/SysCoachModel.java`
- 修改`getCoachesByCourseId`方法，查询时包含`SYS_COACH_COURSE.COACH_FEE`字段

### 6. 服务层更新

#### 更新CourseServiceImpl类
**文件**: `src/main/java/com/lesson/service/impl/CourseServiceImpl.java`

**创建课程逻辑**:
```java
// 验证教练列表
if (Boolean.TRUE.equals(request.getIsMultiTeacher())) {
    // 多教师教学模式
    if (CollectionUtils.isEmpty(request.getCoachFees())) {
        throw new BusinessException("多教师教学模式下，至少需要选择一个教练");
    }
    
    // 验证教练是否存在且属于当前机构
    for (CoachFeeRequest coachFee : request.getCoachFees()) {
        sysCoachModel.validateCoach(coachFee.getCoachId(), request.getCampusId(), institutionId);
    }
} else {
    // 单教师教学模式
    if (CollectionUtils.isEmpty(request.getCoachFees()) || request.getCoachFees().size() != 1) {
        throw new BusinessException("单教师教学模式下，只能选择一个教练");
    }
    
    // 验证教练是否存在且属于当前机构
    sysCoachModel.validateCoach(request.getCoachFees().get(0).getCoachId(), request.getCampusId(), institutionId);
}

// 创建课程-教练关联关系
for (CoachFeeRequest coachFee : request.getCoachFees()) {
    courseModel.createCourseCoachRelation(courseId, coachFee.getCoachId(), coachFee.getCoachFee());
}
```

**更新课程逻辑**:
- 在更新课程时同样处理教练课时费
- 支持修改现有教练的课时费

**返回教练信息**:
```java
// 设置教练信息
List<CoachDetailRecord> coaches = sysCoachModel.getCoachesByCourseId(id);
if (coaches != null && !coaches.isEmpty()) {
    List<CourseVO.CoachInfo> coachInfos = coaches.stream()
        .map(coach -> {
            CourseVO.CoachInfo coachInfo = new CourseVO.CoachInfo();
            coachInfo.setId(coach.getId());
            coachInfo.setName(coach.getName());
            coachInfo.setCoachFee(coach.getCoachFee()); // 设置课时费
            return coachInfo;
        })
        .collect(Collectors.toList());
    vo.setCoaches(coachInfos);
}
```

## 功能特性

### 1. 多教师课时费支持
- 支持为每个教练设置独立的课时费
- 在多教师教学模式下，可以指定每个教练的具体课时费
- 在单教师教学模式下，使用课程的默认课时费

### 2. 向后兼容
- 如果多教师教学但没有提供教练课时费列表，使用默认课时费
- 现有单教师课程不受影响，继续使用原有逻辑

### 3. 数据完整性
- 教练课时费存储在教练课程关联表中，确保数据一致性
- 支持课时费的更新和修改

### 4. API接口
- 创建课程：支持`coachFees`参数
- 更新课程：支持修改教练课时费
- 查询课程：返回每个教练的课时费信息

## 测试用例

### 1. 创建多教师课程（不同课时费）
```json
{
  "name": "多教师大课测试-不同课时费",
  "isMultiTeacher": true,
  "coachFees": [
    {"coachId": 1, "coachFee": 90.00},
    {"coachId": 2, "coachFee": 95.00},
    {"coachId": 3, "coachFee": 95.00}
  ]
}
```

### 2. 创建单教师课程（默认课时费）
```json
{
  "name": "单教师一对一课程",
  "isMultiTeacher": false,
  "coachFees": [
    {"coachId": 1, "coachFee": 100.00}
  ]
}
```

### 3. 更新课程课时费
```json
{
  "id": 1,
  "isMultiTeacher": true,
  "coachFees": [
    {"coachId": 1, "coachFee": 85.00},
    {"coachId": 2, "coachFee": 90.00},
    {"coachId": 3, "coachFee": 92.00}
  ]
}
```

## 技术要点

### 1. 数据库设计
- 在教练课程关联表中添加课时费字段
- 保持数据范式，避免冗余

### 2. 业务逻辑
- 多教师模式下优先使用指定课时费
- 单教师模式下使用默认课时费
- 支持课时费的动态更新

### 3. 接口设计
- 请求参数向后兼容
- 返回数据包含完整的教练课时费信息
- 支持批量操作

## 总结

本次实现成功为课程管理系统添加了多教师课时费支持，满足了不同教练在同一个课程中有不同课时费的需求。通过数据库字段扩展、JOOQ模型更新、服务层逻辑优化，实现了完整的功能支持，同时保持了系统的向后兼容性。

主要改进包括：
1. 数据库层面支持教练课时费存储
2. API接口支持课时费设置和查询
3. 业务逻辑支持多教师课时费管理
4. 完整的测试用例覆盖

该功能现已完成开发并通过编译测试，可以投入使用。 