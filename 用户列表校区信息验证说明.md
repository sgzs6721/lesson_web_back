# 用户列表校区信息验证说明

## 概述

用户列表接口的校区信息返回逻辑如下：
- **校区管理员角色**: 在 `roles` 数组中包含 `campusId` 和 `campusName` 字段
- **其他角色**: 不包含校区信息字段（使用 `@JsonInclude(JsonInclude.Include.NON_NULL)` 排除null值）

## 校区信息返回位置

校区信息在用户列表接口的 `roles` 数组中返回，具体位置：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "total": 10,
    "list": [
      {
        "id": 1,
        "realName": "张三",
        "phone": "13800138000",
        "roles": [
          {
            "id": 3,
            "name": "校区管理员",
            "roleEnum": "CAMPUS_ADMIN",
            "campusId": 1,        // 校区管理员角色才有此字段
            "campusName": "北京朝阳校区"  // 校区管理员角色才有此字段
          }
        ],
        "status": "ENABLED",
        "createdTime": "2024-01-15T10:30:00",
        "lastLoginTime": "2024-01-15T15:30:00"
      }
    ]
  }
}
```

## 不同角色的校区信息显示

### 1. 超级管理员角色
```json
{
  "id": 1,
  "name": "超级管理员",
  "roleEnum": "SUPER_ADMIN"
  // 不包含 campusId 和 campusName 字段
}
```

### 2. 协同管理员角色
```json
{
  "id": 2,
  "name": "协同管理员",
  "roleEnum": "COLLABORATOR"
  // 不包含 campusId 和 campusName 字段
}
```

### 3. 校区管理员角色
```json
{
  "id": 3,
  "name": "校区管理员",
  "roleEnum": "CAMPUS_ADMIN",
  "campusId": 1,
  "campusName": "北京朝阳校区"
}
```

## 验证方法

### 1. 查看校区管理员用户
```bash
# 调用用户列表接口
GET /api/user/list?pageNum=1&pageSize=10

# 查找 roles 数组中包含 "校区管理员" 的用户
# 这些用户的角色对象中应该包含 campusId 和 campusName 字段
```

### 2. 查看其他角色用户
```bash
# 查找 roles 数组中包含 "超级管理员" 或 "协同管理员" 的用户
# 这些用户的角色对象中不应该包含 campusId 和 campusName 字段
```

### 3. 数据库验证
```sql
-- 查看用户表
SELECT id, real_name, phone, campus_id FROM sys_user WHERE deleted = 0;

-- 查看用户角色关联
SELECT ur.user_id, ur.role_id, r.role_name, u.campus_id 
FROM sys_user_role ur 
JOIN sys_role r ON ur.role_id = r.id 
JOIN sys_user u ON ur.user_id = u.id 
WHERE ur.deleted = 0 AND u.deleted = 0 AND r.deleted = 0;

-- 查看校区信息
SELECT id, name FROM sys_campus WHERE deleted = 0;
```

## 代码逻辑说明

### 1. 校区信息查询
```java
// 查询用户对应的校区信息
Map<Long, UserListVO.CampusInfo> userCampusMap = new HashMap<>();
if (!userIds.isEmpty()) {
    Result<Record3<Long, Long, String>> campusRecords = campusModel.findCampusByUserIds(userIds);
    for (Record3<Long, Long, String> record : campusRecords) {
        UserListVO.CampusInfo campusInfo = new UserListVO.CampusInfo();
        campusInfo.setId(record.value2());  // campus_id
        campusInfo.setName(record.value3()); // name
        userCampusMap.put(record.value1(), campusInfo); // user_id -> campusInfo
    }
}
```

### 2. 角色信息设置
```java
// 如果是校区管理员角色，需要包含校区ID和校区名称
if ("校区管理员".equals(role.getRoleName())) {
    // 获取用户的校区信息
    UserListVO.CampusInfo campusInfo = userCampusMap.get(userId);
    if (campusInfo != null && campusInfo.getId() != null) {
        roleInfo.setCampusId(campusInfo.getId());
        roleInfo.setCampusName(campusInfo.getName());
    }
}
// 其他角色（超级管理员、协同管理员）的campusId和campusName保持为null
```

### 3. JSON序列化配置
```java
@JsonInclude(JsonInclude.Include.NON_NULL)
@Schema(description = "校区ID（校区管理员角色时使用）")
private Long campusId;

@JsonInclude(JsonInclude.Include.NON_NULL)
@Schema(description = "校区名称（校区管理员角色时使用）")
private String campusName;
```

## 常见问题

### 1. 看不到校区信息
**原因**: 查看的用户可能不是校区管理员角色
**解决**: 查找有"校区管理员"角色的用户

### 2. 校区信息为空
**原因**: 用户的 `campus_id` 字段可能为空或无效
**解决**: 检查数据库中的用户校区关联

### 3. 校区名称显示错误
**原因**: 校区表中的数据可能有问题
**解决**: 检查 `sys_campus` 表中的数据

## 测试建议

1. **创建测试用户**: 创建一个校区管理员角色的用户
2. **设置校区关联**: 确保用户关联到正确的校区
3. **调用接口**: 使用用户列表接口查看返回结果
4. **验证字段**: 确认校区管理员角色包含校区信息字段

## 总结

校区信息正确返回在用户列表接口的 `roles` 数组中，只有"校区管理员"角色才会包含 `campusId` 和 `campusName` 字段。其他角色的用户不会显示这些字段，这是正常的设计。 