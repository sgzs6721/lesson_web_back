# 教练统计优化说明

## 概述

为了确保校区规模统计的准确性，我们对教练数量统计进行了优化，现在只统计在职的教练，不包括离职和休假中的教练。

## 问题分析

### 原有问题
- 校区规模统计中的教练数包含了所有状态的教练
- 包括：在职（active）、休假中（vacation）、离职（resigned）
- 这导致统计数字不准确，不能反映校区的实际运营规模

### 教练状态说明
| 状态 | 代码 | 说明 |
|------|------|------|
| 在职 | active | 正常工作的教练 |
| 休假中 | vacation | 暂时休假的教练 |
| 离职 | resigned | 已离职的教练 |

## 修改内容

### 1. 校区详情统计
**文件**: `CampusServiceImpl.java`
**方法**: `getCampus()`

**修改前**:
```java
coachCount = dslContext.selectCount()
    .from(SYS_COACH)
    .where(SYS_COACH.CAMPUS_ID.eq(id))
    .and(SYS_COACH.INSTITUTION_ID.eq(institutionId))
    .and(SYS_COACH.DELETED.eq(0))
    .fetchOneInto(Integer.class);
```

**修改后**:
```java
coachCount = dslContext.selectCount()
    .from(SYS_COACH)
    .where(SYS_COACH.CAMPUS_ID.eq(id))
    .and(SYS_COACH.INSTITUTION_ID.eq(institutionId))
    .and(SYS_COACH.DELETED.eq(0))
    .and(SYS_COACH.STATUS.eq("active")) // 只统计在职教练
    .fetchOneInto(Integer.class);
```

### 2. 校区列表统计
**文件**: `CampusServiceImpl.java`
**方法**: `listCampuses()`

**修改前**:
```java
coachCount = dslContext.selectCount()
    .from(SYS_COACH)
    .where(SYS_COACH.CAMPUS_ID.eq(campusId))
    .and(SYS_COACH.INSTITUTION_ID.eq(finalInstitutionId))
    .and(SYS_COACH.DELETED.eq(0))
    .fetchOneInto(Integer.class);
```

**修改后**:
```java
coachCount = dslContext.selectCount()
    .from(SYS_COACH)
    .where(SYS_COACH.CAMPUS_ID.eq(campusId))
    .and(SYS_COACH.INSTITUTION_ID.eq(finalInstitutionId))
    .and(SYS_COACH.DELETED.eq(0))
    .and(SYS_COACH.STATUS.eq("active")) // 只统计在职教练
    .fetchOneInto(Integer.class);
```

### 3. Redis缓存刷新
**文件**: `CampusStatsRedisServiceImpl.java`
**方法**: `refreshCampusStats()`

**修改前**:
```java
Integer coachCount = dsl.selectCount()
    .from(table("sys_coach"))
    .where(field("campus_id").eq(campusId))
    .and(field("institution_id").eq(institutionId))
    .and(field("deleted").eq(0))
    .fetchOneInto(Integer.class);
```

**修改后**:
```java
Integer coachCount = dsl.selectCount()
    .from(table("sys_coach"))
    .where(field("campus_id").eq(campusId))
    .and(field("institution_id").eq(institutionId))
    .and(field("deleted").eq(0))
    .and(field("status").eq("active")) // 只统计在职教练
    .fetchOneInto(Integer.class);
```

## 影响范围

### 1. 校区规模统计
- 校区详情页面的教练数量
- 校区列表页面的教练数量
- 校区统计数据的准确性

### 2. 缓存数据
- Redis中的教练数量缓存
- 缓存刷新时的数据准确性

### 3. 前端展示
- 校区规模卡片中的教练数显示
- 统计报表中的教练数量

## 数据一致性

### 1. 缓存更新
当教练状态发生变化时，需要更新相关缓存：

```java
// 教练状态变更时，刷新校区统计缓存
campusStatsRedisService.refreshCampusStats(institutionId, campusId);
```

### 2. 实时性
- 新增在职教练：自动增加统计
- 教练离职：需要刷新缓存
- 教练休假：不影响统计（仍算在职）

## 使用建议

### 1. 教练状态管理
- 及时更新教练状态
- 离职教练应及时标记为 `resigned`
- 休假教练标记为 `vacation`，复职后改回 `active`

### 2. 缓存管理
- 定期刷新校区统计数据
- 教练状态变更后及时刷新缓存
- 监控缓存数据的准确性

### 3. 数据验证
- 定期对比数据库和缓存数据
- 确保统计数据的准确性
- 监控异常数据

## 示例场景

### 场景1：教练入职
```
1. 创建教练记录，状态设为 "active"
2. 自动增加校区教练数量统计
3. 校区规模显示更新
```

### 场景2：教练离职
```
1. 更新教练状态为 "resigned"
2. 刷新校区统计缓存
3. 校区规模显示减少
```

### 场景3：教练休假
```
1. 更新教练状态为 "vacation"
2. 刷新校区统计缓存
3. 校区规模显示减少（休假期间不计入）
```

## 总结

通过这次优化，我们确保了：

1. **统计准确性**: 只统计真正在职的教练
2. **数据一致性**: 缓存和数据库数据保持一致
3. **业务合理性**: 反映校区的实际运营规模
4. **维护便利性**: 自动化的缓存更新机制

这个优化提升了校区规模统计的准确性和可信度，为管理决策提供了更可靠的数据支持。 