# 教练管理新增字段功能实现报告

## 需求分析

根据前端表单显示，需要为教练管理增加以下新字段：

1. **工作类型** (work_type) - 全职/兼职
2. **身份证号** (id_number) - 身份证号码
3. **执教日期** (coaching_date) - 开始执教日期
4. **保底课时** (guaranteed_hours) - 保底课时数

## 实现方案

### 1. 数据库设计修改

#### 1.1 创建数据库迁移脚本
**文件**：`src/main/resources/db/migration/V27__add_coach_additional_fields.sql`

```sql
-- 为教练表添加新字段
ALTER TABLE `sys_coach` 
ADD COLUMN `work_type` varchar(20) NOT NULL DEFAULT 'FULL_TIME' COMMENT '工作类型：FULL_TIME-全职，PART_TIME-兼职' AFTER `gender`,
ADD COLUMN `id_number` varchar(18) DEFAULT NULL COMMENT '身份证号' AFTER `phone`,
ADD COLUMN `coaching_date` date DEFAULT NULL COMMENT '执教日期' AFTER `hire_date`;

-- 为教练薪资表添加保底课时字段
ALTER TABLE `sys_coach_salary` 
ADD COLUMN `guaranteed_hours` int(11) NOT NULL DEFAULT 0 COMMENT '保底课时' AFTER `base_salary`;

-- 添加索引
ALTER TABLE `sys_coach` 
ADD KEY `idx_work_type` (`work_type`),
ADD KEY `idx_id_number` (`id_number`),
ADD KEY `idx_coaching_date` (`coaching_date`);

-- 添加身份证号唯一约束（软删除考虑）
ALTER TABLE `sys_coach` 
ADD UNIQUE KEY `uk_id_number_deleted` (`id_number`, `deleted`);
```

**设计说明**：
- `work_type`：工作类型，默认为全职，支持全职/兼职
- `id_number`：身份证号，可为空，添加唯一约束防止重复
- `coaching_date`：执教日期，可为空
- `guaranteed_hours`：保底课时，默认为0，存储在薪资表中

### 2. 枚举定义

#### 2.1 创建工作类型枚举
**文件**：`src/main/java/com/lesson/common/enums/WorkType.java`

```java
@Getter
public enum WorkType {
    /**
     * 全职
     */
    FULL_TIME("FULL_TIME", "全职", "全职工作"),

    /**
     * 兼职
     */
    PART_TIME("PART_TIME", "兼职", "兼职工作");

    private final String code;
    private final String name;
    private final String description;

    // 构造函数和转换方法...
}
```

### 3. 接口层修改

#### 3.1 修改教练创建请求
**文件**：`src/main/java/com/lesson/request/coach/CoachCreateRequest.java`

**新增字段**：
```java
/**
 * 工作类型
 */
@NotNull(message = "工作类型不能为空")
@Schema(description = "工作类型", required = true, example = "FULL_TIME")
private WorkType workType;

/**
 * 身份证号
 */
@Pattern(regexp = "^[1-9]\\d{5}(18|19|20)\\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\\d{3}[0-9Xx]$", message = "身份证号格式不正确")
@Schema(description = "身份证号", example = "110101199001011234")
private String idNumber;

/**
 * 执教日期
 */
@Schema(description = "执教日期", example = "2023-01-01")
private LocalDate coachingDate;

/**
 * 保底课时
 */
@NotNull(message = "保底课时不能为空")
@Min(value = 0, message = "保底课时不能为负数")
@Schema(description = "保底课时", required = true, example = "160")
private Integer guaranteedHours;
```

#### 3.2 修改教练更新请求
**文件**：`src/main/java/com/lesson/request/coach/CoachUpdateRequest.java`

**新增字段**：
```java
@Schema(description = "工作类型", example = "FULL_TIME")
private WorkType workType;

@Pattern(regexp = "^[1-9]\\d{5}(18|19|20)\\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\\d{3}[0-9Xx]$", message = "身份证号格式不正确")
@Schema(description = "身份证号", example = "110101199001011234")
private String idNumber;

@Schema(description = "执教日期", example = "2023-01-01")
private LocalDate coachingDate;

@Min(value = 0, message = "保底课时不能为负数")
@Schema(description = "保底课时", example = "160")
private Integer guaranteedHours;
```

### 4. 数据访问层修改

#### 4.1 更新JOOQ表结构
**文件**：`src/main/java/com/lesson/repository/tables/SysCoach.java`

**新增字段**：
```java
/**
 * The column <code>lesson_prod.sys_coach.work_type</code>. 工作类型：FULL_TIME-全职，PART_TIME-兼职
 */
public final TableField<SysCoachRecord, String> WORK_TYPE = createField(DSL.name("work_type"), SQLDataType.VARCHAR(20).nullable(false).defaultValue(DSL.inline("FULL_TIME", SQLDataType.VARCHAR)), this, "工作类型：FULL_TIME-全职，PART_TIME-兼职");

/**
 * The column <code>lesson_prod.sys_coach.id_number</code>. 身份证号
 */
public final TableField<SysCoachRecord, String> ID_NUMBER = createField(DSL.name("id_number"), SQLDataType.VARCHAR(18), this, "身份证号");

/**
 * The column <code>lesson_prod.sys_coach.coaching_date</code>. 执教日期
 */
public final TableField<SysCoachRecord, LocalDate> COACHING_DATE = createField(DSL.name("coaching_date"), SQLDataType.LOCALDATE, this, "执教日期");
```

**文件**：`src/main/java/com/lesson/repository/tables/SysCoachSalary.java`

**新增字段**：
```java
/**
 * The column <code>lesson_prod.sys_coach_salary.guaranteed_hours</code>. 保底课时
 */
public final TableField<SysCoachSalaryRecord, Integer> GUARANTEED_HOURS = createField(DSL.name("guaranteed_hours"), SQLDataType.INTEGER.nullable(false).defaultValue(DSL.inline("0", SQLDataType.INTEGER)), this, "保底课时");
```

#### 4.2 修改教练Model
**文件**：`src/main/java/com/lesson/model/SysCoachModel.java`

**修改createCoach方法**：
```java
public Long createCoach(String name, CoachStatus status, Integer age, String phone,
                         String avatar, String jobTitle, LocalDate hireDate,
                         Integer experience, Gender gender, WorkType workType, 
                         String idNumber, LocalDate coachingDate, Long campusId, Long institutionId) {
    // 参数验证
    if (workType == null) {
        throw new IllegalArgumentException("工作类型不能为空");
    }
    
    // 创建教练记录
    dsl.insertInto(SYS_COACH)
            .set(SYS_COACH.WORK_TYPE, workType.getCode())
            .set(SYS_COACH.ID_NUMBER, idNumber)
            .set(SYS_COACH.COACHING_DATE, coachingDate)
            // ... 其他字段
            .execute();
}
```

**修改addSalary方法**：
```java
public void addSalary(Long coachId, BigDecimal baseSalary, Integer guaranteedHours, BigDecimal socialInsurance,
                     BigDecimal classFee, BigDecimal performanceBonus, BigDecimal commission,
                     BigDecimal dividend, LocalDate effectiveDate) {
    dsl.insertInto(SYS_COACH_SALARY)
       .set(SYS_COACH_SALARY.GUARANTEED_HOURS, guaranteedHours)
       // ... 其他字段
       .execute();
}
```

### 5. 业务逻辑层修改

#### 5.1 修改教练服务实现
**文件**：`src/main/java/com/lesson/service/impl/CoachServiceImpl.java`

**修改createCoach方法**：
```java
// 创建教练记录
Long coachId = coachModel.createCoach(
    request.getName(),
    request.getStatus(),
    request.getAge(),
    request.getPhone(),
    request.getAvatar(),
    request.getJobTitle(),
    request.getHireDate(),
    request.getExperience(),
    request.getGender(),
    request.getWorkType(),        // 新增
    request.getIdNumber(),        // 新增
    request.getCoachingDate(),    // 新增
    request.getCampusId(),
    institutionId
);

// 创建教练薪资记录
coachModel.addSalary(
    coachId,
    request.getBaseSalary(),
    request.getGuaranteedHours(), // 新增
    request.getSocialInsurance(),
    request.getClassFee(),
    request.getPerformanceBonus(),
    request.getCommission(),
    request.getDividend(),
    request.getHireDate()
);
```

**修改updateCoach方法**：
```java
// 更新薪资信息（如果有提供薪资相关字段）
if (request.getBaseSalary() != null || request.getGuaranteedHours() != null || 
    request.getSocialInsurance() != null || request.getClassFee() != null || 
    request.getPerformanceBonus() != null || request.getCommission() != null || 
    request.getDividend() != null) {
    
    coachModel.addSalary(
        request.getId(),
        request.getBaseSalary(),
        request.getGuaranteedHours(), // 新增
        request.getSocialInsurance(),
        request.getClassFee(),
        request.getPerformanceBonus(),
        request.getCommission(),
        request.getDividend(),
        LocalDate.now()
    );
}
```

## 数据验证规则

### 1. 工作类型验证
- 必填字段
- 只能是 `FULL_TIME`（全职）或 `PART_TIME`（兼职）
- 默认为 `FULL_TIME`

### 2. 身份证号验证
- 可选字段
- 格式验证：18位身份证号格式
- 唯一性约束：同一机构内不能重复
- 软删除考虑：已删除的记录不参与唯一性检查

### 3. 执教日期验证
- 可选字段
- 日期格式验证
- 不能晚于当前日期

### 4. 保底课时验证
- 必填字段
- 不能为负数
- 默认为0
- 存储在薪资表中，便于薪资计算

## 业务逻辑

### 1. 教练创建流程
1. 验证基本信息（姓名、性别、年龄等）
2. 验证新字段（工作类型、身份证号格式、执教日期）
3. 创建教练基本信息记录
4. 创建薪资记录（包含保底课时）
5. 添加证书信息
6. 更新Redis缓存

### 2. 教练更新流程
1. 验证教练存在性和权限
2. 更新基本信息（包括新字段）
3. 更新薪资信息（包括保底课时）
4. 更新证书信息
5. 更新Redis缓存

### 3. 数据存储策略
- **基本信息**：存储在 `sys_coach` 表
- **薪资信息**：存储在 `sys_coach_salary` 表
- **证书信息**：存储在 `sys_coach_certification` 表
- **保底课时**：存储在薪资表中，便于薪资计算

## 测试建议

### 1. 功能测试
1. 创建教练时填写所有新字段
2. 创建教练时不填写可选字段
3. 更新教练时修改新字段
4. 验证身份证号唯一性约束
5. 验证工作类型枚举值

### 2. 数据验证测试
1. 身份证号格式验证
2. 保底课时负数验证
3. 执教日期格式验证
4. 工作类型枚举验证

### 3. 业务逻辑测试
1. 薪资计算时考虑保底课时
2. 教练统计时考虑工作类型
3. 数据查询时新字段正确显示

## 部署注意事项

1. **数据库迁移**：执行V27迁移脚本
2. **代码部署**：部署支持新字段的代码版本
3. **数据验证**：验证现有数据是否正确
4. **功能测试**：测试新字段的创建和更新功能

## 总结

通过以上实现，教练管理系统现在支持：

1. **工作类型管理**：支持全职/兼职分类
2. **身份证号管理**：支持身份证号录入和唯一性验证
3. **执教日期管理**：支持执教开始日期记录
4. **保底课时管理**：支持保底课时设置，便于薪资计算

这些新字段的添加使教练管理更加完善，能够更好地支持实际业务需求。 