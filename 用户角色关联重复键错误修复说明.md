# 用户角色关联重复键错误修复说明

## 问题描述

在更新用户时出现以下错误：
```
更新用户失败: SQL [insert into `lesson_prod`.`sys_user_role` (`user_id`, `role_id`) values (?, ?)]; 
Duplicate entry '2-2' for key 'sys_user_role.uk_user_role'
```

## 错误原因

1. **唯一约束冲突**: 数据库表 `sys_user_role` 有唯一约束 `uk_user_role`（用户ID + 角色ID）
2. **软删除逻辑问题**: 在 `assignRolesToUser` 方法中，先软删除用户的所有角色关联（设置 `deleted = 1`），然后重新插入
3. **重复插入**: 当尝试插入已存在的用户角色关联时，由于唯一约束导致插入失败

## 修复方案

### 修改 `SysUserRoleModel.assignRoleToUser` 方法

**修改前**:
```java
public Long assignRoleToUser(Long userId, Long roleId) {
    return dsl.insertInto(SYS_USER_ROLE)
            .set(SYS_USER_ROLE.USER_ID, userId)
            .set(SYS_USER_ROLE.ROLE_ID, roleId)
            .returning(SYS_USER_ROLE.ID)
            .fetchOne()
            .getId();
}
```

**修改后**:
```java
public Long assignRoleToUser(Long userId, Long roleId) {
    // 先检查是否已存在该用户角色关联（包括已删除的）
    Long existingId = dsl.select(SYS_USER_ROLE.ID)
            .from(SYS_USER_ROLE)
            .where(SYS_USER_ROLE.USER_ID.eq(userId))
            .and(SYS_USER_ROLE.ROLE_ID.eq(roleId))
            .fetchOneInto(Long.class);
    
    if (existingId != null) {
        // 如果存在，则恢复该记录（设置deleted=0）
        dsl.update(SYS_USER_ROLE)
                .set(SYS_USER_ROLE.DELETED, 0)
                .where(SYS_USER_ROLE.ID.eq(existingId))
                .execute();
        return existingId;
    } else {
        // 如果不存在，则插入新记录
        return dsl.insertInto(SYS_USER_ROLE)
                .set(SYS_USER_ROLE.USER_ID, userId)
                .set(SYS_USER_ROLE.ROLE_ID, roleId)
                .returning(SYS_USER_ROLE.ID)
                .fetchOne()
                .getId();
    }
}
```

## 修复逻辑

### 1. 检查现有记录
- 查询数据库中是否已存在该用户角色关联（不考虑 `deleted` 状态）
- 如果存在，获取记录ID

### 2. 恢复或插入
- **如果记录存在**: 将 `deleted` 字段设置为 0，恢复该记录
- **如果记录不存在**: 插入新的用户角色关联记录

### 3. 返回记录ID
- 无论是恢复还是插入，都返回记录ID

## 优势

1. **避免重复键错误**: 通过先检查再操作的方式，避免唯一约束冲突
2. **保持数据完整性**: 不会丢失历史数据，只是恢复软删除的记录
3. **提高性能**: 避免不必要的删除和插入操作
4. **支持软删除**: 完全兼容现有的软删除机制

## 使用场景

这个修复主要解决以下场景：
1. 用户更新角色时，新角色列表中包含用户已有的角色
2. 用户角色被软删除后，重新分配相同角色
3. 批量更新用户角色时的重复处理

## 测试建议

1. **正常更新测试**: 更新用户角色，包含新的和已有的角色
2. **重复角色测试**: 更新用户角色，包含重复的角色ID
3. **软删除恢复测试**: 为已软删除的用户角色关联重新分配角色
4. **批量操作测试**: 测试多个用户同时更新角色的场景

## 注意事项

1. **事务处理**: 确保在事务中执行，保证数据一致性
2. **并发处理**: 在高并发场景下，可能需要添加适当的锁机制
3. **性能考虑**: 对于大量用户角色更新，可能需要批量处理优化 