# 课程搜索功能修复报告

## 问题描述
用户反馈课程管理界面中的搜索功能没有生效，具体包括：
1. 课程名称搜索不生效
2. 课程类型筛选不生效（前端传递`typeIds`参数，但后端只支持单个`typeId`）
3. 教练筛选不生效（需要支持多教练筛选）

## 问题分析

### 1. 课程类型筛选问题
- **前端传递参数**: `typeIds=11&typeIds=12`（多个课程类型ID）
- **后端接收参数**: `typeId`（单个课程类型ID）
- **问题**: 参数名不匹配，导致筛选失效

### 2. 教练筛选问题
- **前端需求**: 支持多教练筛选
- **后端实现**: 只支持单个教练筛选
- **问题**: 功能不完整

### 3. 课程名称搜索问题
- **后端实现**: 已支持课程名称模糊搜索
- **可能问题**: 参数传递或数据库查询问题

## 修复方案

### 1. 支持多课程类型筛选

#### 更新课程查询请求类
**文件**: `src/main/java/com/lesson/vo/request/CourseQueryRequest.java`
```java
// 修改前
@Schema(description = "课程类型ID（系统常量ID）")
private Long typeId;

// 修改后
@Schema(description = "课程类型ID列表（系统常量ID）")
private List<Long> typeIds;
```

#### 更新课程模型类
**文件**: `src/main/java/com/lesson/model/EduCourseModel.java`
```java
// 修改方法签名
public List<CourseDetailRecord> listCourses(String keyword, List<Long> typeIds, CourseStatus status,
                                            List<Long> coachIds, Long campusId, Long institutionId,
                                            String sortField, String sortOrder,
                                            int pageNum, int pageSize)

// 修改筛选逻辑
if (typeIds != null && !typeIds.isEmpty()) {
  query.and(EDU_COURSE.TYPE_ID.in(typeIds));
}
```

### 2. 支持多教练筛选

#### 更新课程查询请求类
**文件**: `src/main/java/com/lesson/vo/request/CourseQueryRequest.java`
```java
// 修改前
@Schema(description = "教练ID")
private Long coachId;

// 修改后
@Schema(description = "教练ID列表")
private List<Long> coachIds;
```

#### 更新课程模型类
**文件**: `src/main/java/com/lesson/model/EduCourseModel.java`
```java
// 修改方法签名
public List<CourseDetailRecord> listCourses(String keyword, List<Long> typeIds, CourseStatus status,
                                            List<Long> coachIds, Long campusId, Long institutionId,
                                            String sortField, String sortOrder,
                                            int pageNum, int pageSize)

// 修改筛选逻辑
if (coachIds != null && !coachIds.isEmpty()) {
  // 通过教练-课程关联表筛选多个教练
  query.and(EDU_COURSE.ID.in(
      dsl.select(SYS_COACH_COURSE.COURSE_ID)
          .from(SYS_COACH_COURSE)
          .where(SYS_COACH_COURSE.COACH_ID.in(coachIds))
          .and(SYS_COACH_COURSE.DELETED.eq(0))
  ));
}
```

### 3. 更新服务层调用

**文件**: `src/main/java/com/lesson/service/impl/CourseServiceImpl.java`
```java
// 更新方法调用
List<CourseDetailRecord> records = courseModel.listCourses(
    request.getKeyword(),
    request.getTypeIds(),        // 修改为多课程类型
    request.getStatus(),
    request.getCoachIds(),       // 修改为多教练
    request.getCampusId(),
    request.getInstitutionId(),
    request.getSortField(),
    request.getSortOrder(),
    request.getPageNum(),
    request.getPageSize()
);
```

## 功能特性

### 1. 课程名称搜索
- 支持模糊搜索课程名称
- 使用`LIKE '%keyword%'`查询

### 2. 多课程类型筛选
- 支持选择多个课程类型
- 使用`IN`查询匹配任意一个类型

### 3. 多教练筛选
- 支持选择多个教练
- 通过教练-课程关联表查询
- 返回包含任意一个指定教练的课程

### 4. 组合筛选
- 支持多个筛选条件组合使用
- 所有条件之间为AND关系

### 5. 排序功能
- 支持按创建时间、名称等字段排序
- 支持升序和降序

## 测试用例

### 1. 多课程类型筛选
```
GET /api/courses/list?typeIds=11&typeIds=12
```
预期：返回课程类型ID为11或12的课程

### 2. 多教练筛选
```
GET /api/courses/list?coachIds=1&coachIds=2
```
预期：返回包含教练ID为1或2的课程

### 3. 组合筛选
```
GET /api/courses/list?keyword=瑜伽&typeIds=11&typeIds=12&coachIds=1&coachIds=2&status=ACTIVE&campusId=1
```
预期：返回同时满足所有条件的课程

### 4. 您提供的URL格式
```
GET /api/courses/list?page=1&pageSize=10&typeIds=11&typeIds=12&sortField=createdTime&sortOrder=desc&campusId=1
```
预期：返回指定课程类型、按创建时间降序排列的课程

## 编译验证
- ✅ 项目编译成功
- ✅ 无语法错误
- ✅ 无类型错误

## 修复总结

1. **多课程类型筛选**: 将`typeId`改为`typeIds`，支持List<Long>类型
2. **多教练筛选**: 将`coachId`改为`coachIds`，支持List<Long>类型
3. **SQL查询优化**: 使用`IN`查询替代`EQ`查询
4. **向后兼容**: 保持其他筛选功能不变

现在课程搜索功能应该可以正常工作了，支持：
- 课程名称模糊搜索
- 多课程类型筛选
- 多教练筛选
- 组合筛选
- 排序和分页 