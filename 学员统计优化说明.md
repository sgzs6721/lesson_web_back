# 学员统计优化说明

## 概述

为了确保学员统计的准确性，我们对学员数量统计进行了优化，现在只统计在学的学员，不包括停课、结业等其他状态的学员。

## 问题分析

### 原有问题
- 学员管理页面的学员总数统计包含了所有状态的学员
- 包括：在学（STUDYING）、停课（SUSPENDED）、结业（GRADUATED）等
- 这导致统计数字不准确，不能反映校区的实际在学学员规模

### 学员状态说明
| 状态 | 代码 | 说明 |
|------|------|------|
| 在学 | STUDYING | 正常学习的学员 |
| 停课 | SUSPENDED | 暂时停课的学员 |
| 结业 | GRADUATED | 已完成学习的学员 |

## 修改内容

### 1. 学员管理页面统计（校区管理员）
**文件**: `StatisticsController.java`
**方法**: `getStudentManagementSummary()`

**修改前**:
```java
totalStudents = dslContext.selectCount()
    .from(EduStudent.EDU_STUDENT)
    .where(EduStudent.EDU_STUDENT.DELETED.eq(0))
    .and(EduStudent.EDU_STUDENT.INSTITUTION_ID.eq(institutionId))
    .and(EduStudent.EDU_STUDENT.CAMPUS_ID.eq(userCampusId))
    .fetchOneInto(Integer.class);
```

**修改后**:
```java
totalStudents = dslContext.selectCount()
    .from(EduStudent.EDU_STUDENT)
    .where(EduStudent.EDU_STUDENT.DELETED.eq(0))
    .and(EduStudent.EDU_STUDENT.INSTITUTION_ID.eq(institutionId))
    .and(EduStudent.EDU_STUDENT.CAMPUS_ID.eq(userCampusId))
    .and(EduStudent.EDU_STUDENT.STATUS.eq("STUDYING")) // 只统计在学学员
    .fetchOneInto(Integer.class);
```

### 2. 学员管理页面统计（超级管理员）
**文件**: `StatisticsController.java`
**方法**: `getStudentManagementSummary()`

**修改前**:
```java
totalStudents = dslContext.selectCount()
    .from(EduStudent.EDU_STUDENT)
    .where(EduStudent.EDU_STUDENT.DELETED.eq(0))
    .and(EduStudent.EDU_STUDENT.INSTITUTION_ID.eq(institutionId))
    .fetchOneInto(Integer.class);
```

**修改后**:
```java
totalStudents = dslContext.selectCount()
    .from(EduStudent.EDU_STUDENT)
    .where(EduStudent.EDU_STUDENT.DELETED.eq(0))
    .and(EduStudent.EDU_STUDENT.INSTITUTION_ID.eq(institutionId))
    .and(EduStudent.EDU_STUDENT.STATUS.eq("STUDYING")) // 只统计在学学员
    .fetchOneInto(Integer.class);
```

### 3. 学员管理页面详细统计（校区管理员）
**文件**: `StatisticsController.java`
**方法**: `getStudentManagementDetail()`

**修改前**:
```java
totalStudents = dslContext.selectCount()
    .from(EduStudent.EDU_STUDENT)
    .where(EduStudent.EDU_STUDENT.DELETED.eq(0))
    .and(EduStudent.EDU_STUDENT.INSTITUTION_ID.eq(institutionId))
    .and(EduStudent.EDU_STUDENT.CAMPUS_ID.eq(userCampusId))
    .fetchOneInto(Integer.class);
```

**修改后**:
```java
totalStudents = dslContext.selectCount()
    .from(EduStudent.EDU_STUDENT)
    .where(EduStudent.EDU_STUDENT.DELETED.eq(0))
    .and(EduStudent.EDU_STUDENT.INSTITUTION_ID.eq(institutionId))
    .and(EduStudent.EDU_STUDENT.CAMPUS_ID.eq(userCampusId))
    .and(EduStudent.EDU_STUDENT.STATUS.eq("STUDYING")) // 只统计在学学员
    .fetchOneInto(Integer.class);
```

### 4. 学员管理页面详细统计（超级管理员）
**文件**: `StatisticsController.java`
**方法**: `getStudentManagementDetail()`

**修改前**:
```java
totalStudents = dslContext.selectCount()
    .from(EduStudent.EDU_STUDENT)
    .where(EduStudent.EDU_STUDENT.DELETED.eq(0))
    .and(EduStudent.EDU_STUDENT.INSTITUTION_ID.eq(institutionId))
    .fetchOneInto(Integer.class);
```

**修改后**:
```java
totalStudents = dslContext.selectCount()
    .from(EduStudent.EDU_STUDENT)
    .where(EduStudent.EDU_STUDENT.DELETED.eq(0))
    .and(EduStudent.EDU_STUDENT.INSTITUTION_ID.eq(institutionId))
    .and(EduStudent.EDU_STUDENT.STATUS.eq("STUDYING")) // 只统计在学学员
    .fetchOneInto(Integer.class);
```

## 影响范围

### 1. 学员管理页面
- 学员总数显示更准确
- 只统计真正在学的学员
- 反映校区的实际运营规模

### 2. 统计数据
- 校区学员数量统计
- 机构学员总数统计
- 缓存数据的准确性

### 3. 前端展示
- 学员管理页面的学员总数
- 统计报表中的学员数量
- 校区规模统计

## 数据一致性

### 1. 缓存更新
当学员状态发生变化时，需要更新相关缓存：

```java
// 学员状态变更时，刷新校区统计缓存
campusStatsRedisService.refreshCampusStats(institutionId, campusId);
```

### 2. 实时性
- 新增在学学员：自动增加统计
- 学员停课：需要刷新缓存
- 学员结业：需要刷新缓存

## 使用建议

### 1. 学员状态管理
- 及时更新学员状态
- 停课学员应及时标记为 `SUSPENDED`
- 结业学员标记为 `GRADUATED`
- 复课学员改回 `STUDYING`

### 2. 缓存管理
- 定期刷新学员统计数据
- 学员状态变更后及时刷新缓存
- 监控缓存数据的准确性

### 3. 数据验证
- 定期对比数据库和缓存数据
- 确保统计数据的准确性
- 监控异常数据

## 示例场景

### 场景1：学员报名
```
1. 创建学员记录，状态设为 "STUDYING"
2. 自动增加校区学员数量统计
3. 学员管理页面显示更新
```

### 场景2：学员停课
```
1. 更新学员状态为 "SUSPENDED"
2. 刷新校区统计缓存
3. 学员管理页面显示减少
```

### 场景3：学员结业
```
1. 更新学员状态为 "GRADUATED"
2. 刷新校区统计缓存
3. 学员管理页面显示减少
```

### 场景4：学员复课
```
1. 更新学员状态为 "STUDYING"
2. 刷新校区统计缓存
3. 学员管理页面显示增加
```

## 统计逻辑说明

### 1. 学员总数统计
- **统计范围**: 只统计状态为 `STUDYING` 的学员
- **排除范围**: 停课、结业、删除的学员
- **统计维度**: 按校区、机构分别统计

### 2. 状态分组统计
除了总数统计，还保留了按状态分组的统计：
- `studyingStudents`: 在学学员数量
- `graduatedStudents`: 结业学员数量
- `expiredStudents`: 过期学员数量
- `refundedStudents`: 退费学员数量

### 3. 缓存策略
- 使用Redis缓存统计数据
- 缓存过期时间：24小时
- 状态变更时主动刷新缓存

## 总结

通过这次优化，我们确保了：

1. **统计准确性**: 只统计真正在学的学员
2. **数据一致性**: 缓存和数据库数据保持一致
3. **业务合理性**: 反映校区的实际运营规模
4. **维护便利性**: 自动化的缓存更新机制

这个优化提升了学员统计的准确性和可信度，为管理决策提供了更可靠的数据支持，确保学员管理页面的"学员总数"显示的是真正在学的学员数量。 