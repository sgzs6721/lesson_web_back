# 校区统计数据缓存优化说明

## 概述

为了解决校区管理中教练数量统计包含离职教练的问题，我们对Redis缓存系统进行了优化，确保统计数据只包含在职教练和在学学员。

## 问题分析

### 原有问题
- Redis缓存中存储的教练数量包含了离职教练
- 校区管理页面显示的教练数量不准确
- 缓存数据没有及时更新，导致统计偏差

### 解决方案
1. **优化统计逻辑**: 只统计在职教练（status='active'）
2. **清理旧缓存**: 提供缓存清理接口
3. **刷新统计数据**: 提供数据刷新接口
4. **实时更新**: 教练状态变更时自动刷新缓存

## 统计逻辑优化

### 1. 教练数量统计
**只统计在职教练**:
```sql
SELECT COUNT(*) FROM sys_coach 
WHERE campus_id = ? 
  AND institution_id = ? 
  AND deleted = 0 
  AND status = 'active'  -- 只统计在职教练
```

### 2. 学员数量统计
**只统计在学学员**:
```sql
SELECT COUNT(*) FROM edu_student 
WHERE campus_id = ? 
  AND institution_id = ? 
  AND deleted = 0 
  AND status = 'STUDYING'  -- 只统计在学学员
```

## Redis缓存管理

### 1. 缓存键结构
```
campus:stats:teacher_count:{institutionId}:{campusId}    # 教练数量
campus:stats:student_count:{institutionId}:{campusId}    # 学员数量
campus:stats:course_count:{institutionId}:{campusId}     # 课程数量
campus:stats:consumed_hours:{institutionId}:{campusId}   # 已消耗课时
campus:stats:total_hours:{institutionId}:{campusId}      # 总课时
```

### 2. 缓存清理接口

#### 清理机构所有校区缓存
```bash
DELETE /api/redis/clear-campus-stats/{institutionId}
```

#### 刷新机构所有校区统计数据
```bash
POST /api/redis/refresh-campus-stats/{institutionId}
```

#### 清理并刷新所有校区统计数据
```bash
POST /api/redis/clear-and-refresh-campus-stats/{institutionId}
```

#### 刷新单个校区统计数据
```bash
POST /api/redis/refresh-single-campus-stats/{institutionId}/{campusId}
```

## 使用步骤

### 1. 清理旧缓存
首先清理Redis中存储的旧统计数据：

```bash
# 清理机构ID为1的所有校区统计数据缓存
curl -X DELETE "http://localhost:8080/api/redis/clear-campus-stats/1"
```

### 2. 刷新统计数据
然后刷新统计数据，确保使用新的统计逻辑：

```bash
# 刷新机构ID为1的所有校区统计数据
curl -X POST "http://localhost:8080/api/redis/refresh-campus-stats/1"
```

### 3. 验证结果
查看校区管理页面，确认教练数量已正确更新：

```bash
# 查看校区列表
curl -X GET "http://localhost:8080/api/campus/list?pageNum=1&pageSize=10"
```

## 代码实现

### 1. 缓存清理方法
```java
/**
 * 清理指定机构的所有校区统计数据缓存
 */
public void clearCampusStatsCache(Long institutionId) {
    // 获取该机构的所有校区ID
    List<Long> campusIds = dsl.select(field("id", Long.class))
            .from(table("sys_campus"))
            .where(field("institution_id").eq(institutionId))
            .and(field("deleted").eq(0))
            .fetchInto(Long.class);
    
    // 清理每个校区的缓存
    for (Long campusId : campusIds) {
        clearSingleCampusStatsCache(institutionId, campusId);
    }
}
```

### 2. 统计数据刷新方法
```java
/**
 * 刷新校区统计数据
 */
public void refreshCampusStats(Long institutionId, Long campusId) {
    // 1. 刷新教练数量（只统计在职教练）
    Integer coachCount = dsl.selectCount()
            .from(table("sys_coach"))
            .where(field("campus_id").eq(campusId))
            .and(field("institution_id").eq(institutionId))
            .and(field("deleted").eq(0))
            .and(field("status").eq("active")) // 只统计在职教练
            .fetchOneInto(Integer.class);
    setTeacherCount(institutionId, campusId, coachCount.longValue());
    
    // 2. 刷新学员数量（只统计在学学员）
    Integer studentCount = dsl.selectCount()
            .from(table("edu_student"))
            .where(field("campus_id").eq(campusId))
            .and(field("institution_id").eq(institutionId))
            .and(field("deleted").eq(0))
            .and(field("status").eq("STUDYING"))
            .fetchOneInto(Integer.class);
    setStudentCount(institutionId, campusId, studentCount);
}
```

## 测试验证

### 1. 运行测试脚本
```bash
chmod +x test_campus_stats_cache.sh
./test_campus_stats_cache.sh
```

### 2. 手动验证
1. **查看当前统计数据**: 访问校区管理页面
2. **清理缓存**: 调用清理接口
3. **刷新数据**: 调用刷新接口
4. **验证结果**: 再次查看校区管理页面

### 3. 数据库验证
```sql
-- 查看在职教练数量
SELECT COUNT(*) FROM sys_coach 
WHERE campus_id = 1 
  AND institution_id = 1 
  AND deleted = 0 
  AND status = 'active';

-- 查看在学学员数量
SELECT COUNT(*) FROM edu_student 
WHERE campus_id = 1 
  AND institution_id = 1 
  AND deleted = 0 
  AND status = 'STUDYING';
```

## 注意事项

### 1. 数据一致性
- 清理缓存后，下次访问会自动从数据库重新计算
- 教练状态变更时，建议及时刷新相关校区缓存
- 定期清理和刷新缓存，确保数据准确性

### 2. 性能考虑
- 缓存清理操作会删除所有相关缓存
- 刷新操作会重新计算所有统计数据
- 建议在业务低峰期执行批量操作

### 3. 权限控制
- 缓存管理接口需要管理员权限
- 建议在生产环境中谨慎使用清理操作
- 可以设置操作日志，记录缓存变更

## 故障排除

### 1. 缓存清理失败
**可能原因**: Redis连接问题
**解决方法**: 检查Redis服务状态，确认连接配置

### 2. 统计数据不准确
**可能原因**: 数据库数据不一致
**解决方法**: 检查教练和学员的状态字段

### 3. 接口调用失败
**可能原因**: 权限不足或参数错误
**解决方法**: 检查认证token和参数格式

## 总结

通过这次优化，我们实现了：
1. ✅ 教练数量只统计在职教练
2. ✅ 学员数量只统计在学学员
3. ✅ 提供完整的缓存管理接口
4. ✅ 支持批量清理和刷新操作
5. ✅ 确保数据一致性和准确性

现在校区管理页面的统计数据将准确反映实际的运营情况，不再包含离职教练和退学学员。 