# 教练更新接口字段修复报告

## 问题描述

在检查教练更新接口的入参时，发现`CoachUpdateRequest`中包含了新添加的`workType`字段，但是在`SysCoachModel.updateCoach`方法中没有处理这个字段的更新，导致教练的工作类型无法通过更新接口进行修改。

## 问题分析

1. **入参包含新字段**：`CoachUpdateRequest`中正确包含了`workType`字段
2. **数据库表有对应字段**：`sys_coach`表中有`work_type`字段
3. **模型方法缺少参数**：`SysCoachModel.updateCoach`方法没有`workType`参数
4. **服务层调用错误**：`CoachServiceImpl.updateCoach`方法调用时缺少`workType`参数

## 修复方案

### 1. 修改SysCoachModel.updateCoach方法

**文件**：`src/main/java/com/lesson/model/SysCoachModel.java`

**修改内容**：
- 在方法参数中添加`WorkType workType`参数
- 在SQL更新语句中添加`WORK_TYPE`字段的更新

```java
public void updateCoach(Long id, String name, CoachStatus status, Integer age,
                        String phone, String avatar, String jobTitle, LocalDate hireDate,
                        Integer experience, Gender gender, WorkType workType, Long campusId, Long institutionId) {
    // ... 其他代码保持不变 ...
    
    dsl.update(SYS_COACH)
            .set(SYS_COACH.NAME, name)
            .set(SYS_COACH.STATUS, status.getCode())
            .set(SYS_COACH.AGE, age)
            .set(SYS_COACH.PHONE, phone)
            .set(SYS_COACH.AVATAR, avatar)
            .set(SYS_COACH.JOB_TITLE, jobTitle)
            .set(SYS_COACH.HIRE_DATE, hireDate)
            .set(SYS_COACH.EXPERIENCE, experience)
            .set(SYS_COACH.GENDER, gender.getCode())
            .set(SYS_COACH.WORK_TYPE, workType != null ? workType.getCode() : null)  // 新增
            .set(SYS_COACH.CAMPUS_ID, campusId)
            .set(SYS_COACH.INSTITUTION_ID, institutionId)
            .where(SYS_COACH.ID.eq(id))
            .and(SYS_COACH.DELETED.eq(0))
            .execute();
}
```

### 2. 修改CoachServiceImpl.updateCoach方法

**文件**：`src/main/java/com/lesson/service/impl/CoachServiceImpl.java`

**修改内容**：
- 在调用`coachModel.updateCoach`时添加`workType`参数
- 处理类型转换：从`String`转换为`WorkType`枚举

```java
// 更新教练基本信息
coachModel.updateCoach(
        request.getId(),
        request.getName() != null ? request.getName() : coach.getName(),
        request.getStatus(),
        calculatedAge,  // 使用计算出的年龄
        request.getPhone() != null ? request.getPhone() : coach.getPhone(),
        request.getAvatar() != null ? request.getAvatar() : coach.getAvatar(),
        request.getJobTitle() != null ? request.getJobTitle() : coach.getJobTitle(),
        request.getHireDate() != null ? request.getHireDate() : coach.getHireDate(),
        calculatedExperience,  // 使用计算出的教龄
        request.getGender(),
        request.getWorkType() != null ? request.getWorkType() : WorkType.fromCode(coach.getWorkType()),  // 新增
        request.getCampusId() != null ? request.getCampusId() : coach.getCampusId(),
        institutionId
);
```

## 修复验证

### 1. 编译验证
- 项目编译成功，无语法错误
- 类型转换正确，无类型不匹配错误

### 2. 功能验证
创建了测试文件`coach_update_test.http`，包含以下测试场景：
- 完整更新教练信息（包含所有新字段）
- 部分更新教练信息（只更新工作类型）
- 验证更新后的教练详情

### 3. 字段完整性检查

教练更新接口现在支持以下所有字段的更新：

**基本信息字段**：
- `id`：教练ID（必填）
- `name`：姓名
- `gender`：性别
- `workType`：工作类型（新添加）
- `phone`：联系电话
- `idNumber`：身份证号
- `avatar`：头像URL
- `jobTitle`：职位
- `hireDate`：入职日期
- `coachingDate`：执教日期
- `certifications`：证书列表
- `status`：状态
- `campusId`：所属校区ID

**薪资相关字段**：
- `baseSalary`：基本工资
- `guaranteedHours`：保底课时
- `socialInsurance`：社保费
- `classFee`：课时费
- `performanceBonus`：绩效奖金
- `commission`：提成百分比
- `dividend`：分红

## 总结

通过本次修复，教练更新接口现在能够正确处理所有新添加的字段，特别是`workType`字段。修复内容包括：

1. ✅ 在模型层添加了`workType`参数的处理
2. ✅ 在服务层正确传递`workType`参数
3. ✅ 处理了类型转换问题（String ↔ WorkType枚举）
4. ✅ 保持了向后兼容性（支持部分字段更新）
5. ✅ 验证了编译和功能正确性

教练更新接口现在完全支持新添加字段的更新功能。 