# 学员管理统计接口优化说明

## 概述

根据前端界面需求，将"学员总数"和"课程总数"两个统计数据合并到一个接口中，同时支持校区ID参数进行数据过滤。

## 修改内容

### 1. 接口路径
```
GET /api/statistics/student-management/summary
```

### 2. 新增参数
- `campusId` (可选): 校区ID，不传则根据当前用户权限自动确定

### 3. 返回数据结构优化

#### 修改前
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalStudents": 2,
    "totalCourses": 3,  // 这个字段之前是学员报名课程总数，容易混淆
    "studyingStudents": 2,
    "graduatedStudents": 0,
    "expiredStudents": 0,
    "refundedStudents": 0
  }
}
```

#### 修改后
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalStudents": 2,        // 学员总数（在学状态）
    "totalCourses": 3,         // 课程总数（已发布状态）
    "totalStudentCourses": 5,  // 学员报名课程总数
    "studyingStudents": 2,     // 在学学员
    "graduatedStudents": 0,    // 结业学员
    "expiredStudents": 0,      // 过期学员
    "refundedStudents": 0      // 退费学员
  }
}
```

## 统计逻辑

### 1. 学员总数 (totalStudents)
- **统计范围**: 只统计状态为"STUDYING"（在学）的学员
- **过滤条件**: 
  - `deleted = 0` (未删除)
  - `status = 'STUDYING'` (在学状态)
  - `institution_id = ?` (机构ID)
  - `campus_id = ?` (校区ID，如果指定)

### 2. 课程总数 (totalCourses)
- **统计范围**: 只统计状态为"PUBLISHED"（已发布）的课程
- **过滤条件**:
  - `deleted = 0` (未删除)
  - `status = 'PUBLISHED'` (已发布状态)
  - `institution_id = ?` (机构ID)
  - `campus_id = ?` (校区ID，如果指定)

### 3. 学员报名课程总数 (totalStudentCourses)
- **统计范围**: 学员报名的所有课程记录（不重复的课程ID）
- **过滤条件**:
  - `deleted = 0` (未删除)
  - `institution_id = ?` (机构ID)
  - `campus_id = ?` (校区ID，如果指定)

## 权限控制

### 1. 校区管理员
- 只能查看自己校区的统计数据
- 如果不传`campusId`参数，自动使用用户关联的校区ID

### 2. 超级管理员/机构管理员
- 可以查看整个机构的统计数据
- 可以指定`campusId`参数查看特定校区的统计数据
- 如果不传`campusId`参数，统计整个机构的数据

## 缓存策略

### 1. 超级管理员统计
- 使用Redis缓存机构级别的统计数据
- 课程总数缓存键: `lesson:{env}:institution:{institutionId}:course_count`
- 学员总数缓存键: `lesson:{env}:institution:{institutionId}:student_count`

### 2. 校区管理员统计
- 直接从数据库查询，不使用缓存
- 确保数据的实时性

## 使用示例

### 1. 校区管理员查看自己校区统计
```bash
GET /api/statistics/student-management/summary
```

### 2. 超级管理员查看特定校区统计
```bash
GET /api/statistics/student-management/summary?campusId=1
```

### 3. 超级管理员查看整个机构统计
```bash
GET /api/statistics/student-management/summary
```

## 前端适配建议

1. **字段映射**: 将原来的`totalCourses`字段映射到新的`totalCourses`（课程总数）
2. **新增字段**: 使用`totalStudentCourses`字段显示学员报名课程总数
3. **参数传递**: 在需要查看特定校区统计时，传递`campusId`参数

## 注意事项

1. **数据一致性**: 校区管理员统计直接从数据库查询，确保数据实时性
2. **性能优化**: 超级管理员统计使用Redis缓存，提高查询性能
3. **权限隔离**: 严格按用户权限过滤数据，确保数据安全
4. **字段含义**: 明确区分"课程总数"和"学员报名课程总数"的概念 