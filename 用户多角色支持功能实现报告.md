# 用户多角色支持功能实现报告

## 问题描述

用户角色管理存在以下问题：
1. 当前数据库设计只支持一个用户一个角色（`sys_user`表中的`role_id`字段）
2. 业务需求要求支持一个用户拥有多个角色（除了超级管理员之外，一个用户可以是协同管理员也是校区管理员）
3. 用户创建和更新接口需要支持传入多个角色ID

## 解决方案

### 1. 数据库设计修改

#### 1.1 创建用户角色关联表
**文件**：`src/main/resources/db/migration/V26__create_user_role_relation_table.sql`

```sql
-- 创建用户角色关联表，支持一个用户多个角色
CREATE TABLE `sys_user_role` (
    `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `user_id` bigint(20) NOT NULL COMMENT '用户ID',
    `role_id` bigint(20) NOT NULL COMMENT '角色ID',
    `created_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted` tinyint(4) NOT NULL DEFAULT '0' COMMENT '是否删除：0-未删除，1-已删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_user_role` (`user_id`, `role_id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_role_id` (`role_id`),
    KEY `idx_created_time` (`created_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户角色关联表';

-- 为现有用户数据迁移到新的关联表
INSERT INTO `sys_user_role` (`user_id`, `role_id`, `created_time`, `update_time`, `deleted`)
SELECT 
    u.id as user_id,
    u.role_id,
    u.created_time,
    u.update_time,
    0 as deleted
FROM `sys_user` u
WHERE u.deleted = 0 AND u.role_id IS NOT NULL;
```

**设计说明**：
- 保留原有的`sys_user.role_id`字段，用于向后兼容
- 新增`sys_user_role`关联表，支持多对多关系
- 使用软删除机制，便于数据恢复
- 添加唯一约束防止重复分配

### 2. JOOQ表结构生成

#### 2.1 创建SysUserRole表类
**文件**：`src/main/java/com/lesson/repository/tables/SysUserRole.java`

#### 2.2 创建SysUserRoleRecord记录类
**文件**：`src/main/java/com/lesson/repository/tables/records/SysUserRoleRecord.java`

### 3. 数据访问层实现

#### 3.1 创建用户角色关联Model
**文件**：`src/main/java/com/lesson/model/SysUserRoleModel.java`

**主要方法**：
- `assignRoleToUser(Long userId, Long roleId)` - 为用户分配单个角色
- `assignRolesToUser(Long userId, List<Long> roleIds)` - 批量为用户分配角色
- `deleteUserRoles(Long userId)` - 删除用户的所有角色关联
- `getUserRoleIds(Long userId)` - 获取用户的所有角色ID
- `hasRole(Long userId, Long roleId)` - 检查用户是否拥有指定角色
- `hasAnyRole(Long userId, List<Long> roleIds)` - 检查用户是否拥有指定角色中的任意一个

### 4. 接口层修改

#### 4.1 修改用户创建请求
**文件**：`src/main/java/com/lesson/request/user/UserCreateRequest.java`

**修改内容**：
```java
// 原来的单角色字段
private RoleEnum role;

// 修改为多角色字段
private List<Long> roleIds;
```

#### 4.2 修改用户更新请求
**文件**：`src/main/java/com/lesson/request/user/UserUpdateRequest.java`

**修改内容**：
```java
// 原来的单角色字段
private RoleEnum role;

// 修改为多角色字段
private List<Long> roleIds;
```

### 5. 业务逻辑层修改

#### 5.1 修改用户创建逻辑
**文件**：`src/main/java/com/lesson/service/impl/UserServiceImpl.java`

**主要修改**：
1. 添加`SysUserRoleModel`依赖注入
2. 修改`createUser(UserCreateRequest request)`方法：
   - 验证角色ID列表不为空
   - 检查是否包含超级管理员角色（不允许创建）
   - 检查是否包含校区管理员角色，如果包含则必须指定校区ID
   - 使用第一个角色ID作为主角色，保持向后兼容
   - 创建用户后，为用户分配所有角色

#### 5.2 修改用户更新逻辑
**文件**：`src/main/java/com/lesson/service/impl/UserServiceImpl.java`

**主要修改**：
1. 修改`updateUser(UserUpdateRequest request)`方法：
   - 验证角色ID列表不为空
   - 检查是否包含超级管理员角色（不允许修改为超级管理员）
   - 超级管理员不允许变更角色
   - 检查是否包含校区管理员角色，如果包含则必须指定校区ID
   - 使用第一个角色ID作为主角色，保持向后兼容
   - 更新用户基本信息后，更新用户角色关联

### 6. 业务规则

#### 6.1 角色分配规则
1. **超级管理员**：不允许创建或修改为超级管理员角色
2. **多角色支持**：一个用户可以同时拥有协同管理员和校区管理员角色
3. **校区管理员**：如果用户包含校区管理员角色，必须指定校区ID
4. **向后兼容**：使用第一个角色ID作为主角色，存储在`sys_user.role_id`字段中

#### 6.2 权限验证规则
1. 用户拥有任意一个角色即可访问对应权限
2. 校区管理员角色需要验证校区权限
3. 协同管理员角色拥有机构级别的权限

## 数据迁移策略

### 1. 现有数据处理
- 执行V26迁移脚本，将现有用户的角色数据迁移到`sys_user_role`表
- 保留`sys_user.role_id`字段，确保现有代码继续正常工作

### 2. 向后兼容性
- 现有接口继续使用`role_id`字段作为主角色
- 新增的多角色功能通过`sys_user_role`表实现
- 权限验证同时检查主角色和关联角色

## 测试建议

### 1. 功能测试
1. 创建用户时分配多个角色
2. 更新用户时修改角色组合
3. 验证校区管理员必须指定校区ID
4. 验证不允许创建或修改为超级管理员

### 2. 权限测试
1. 验证多角色用户的权限是否正确
2. 验证校区权限隔离是否正常
3. 验证角色变更后权限是否正确更新

### 3. 数据一致性测试
1. 验证`sys_user.role_id`和`sys_user_role`表数据一致性
2. 验证软删除机制是否正常工作
3. 验证唯一约束是否防止重复分配

## 部署注意事项

1. **数据库迁移**：确保在生产环境执行V26迁移脚本
2. **代码部署**：部署新版本代码，支持多角色功能
3. **数据验证**：验证现有用户数据是否正确迁移
4. **功能测试**：在生产环境测试多角色功能是否正常

## 总结

通过以上修改，系统现在支持：
1. 一个用户拥有多个角色（除了超级管理员）
2. 向后兼容现有单角色设计
3. 灵活的角色分配和权限管理
4. 数据安全和一致性保证

这个实现方案既满足了新的业务需求，又保证了系统的稳定性和向后兼容性。 